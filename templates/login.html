<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoMarket - KullanÄ±cÄ± GiriÅŸi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- TEMA DEÄžÄ°ÅžKENLERÄ° --- */
        :root {
            /* VarsayÄ±lan: YÃ¼ksek KontrastlÄ± KaranlÄ±k Mod (Siyah/SarÄ±) */
            --bg-color: #000000;
            --text-color: #FFFF00;
            --input-bg: #1A1A1A;
            --border-color: #FFFF00;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --focus-color: #00FFFF;
            --mic-border: #FFFFFF;
        }

        /* AÃ§Ä±k Mod (Light Mode) - Beyaz/Siyah YÃ¼ksek Kontrast */
        body.light-mode {
            --bg-color: #FFFFFF;
            --text-color: #000000;
            --input-bg: #F0F0F0;
            --border-color: #000000;
            --button-bg: #000000;
            --button-text: #FFFFFF;
            --focus-color: #0000CC; /* Mavi odak rengi */
            --mic-border: #000000;
        }

        /* --- ERÄ°ÅžÄ°LEBÄ°LÄ°RLÄ°K ODAKLI CSS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-size: 24px;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s; /* GeÃ§iÅŸ animasyonu */
        }

        .container { width: 100%; max-width: 800px; text-align: center; }
        h1 { font-size: 48px; margin-bottom: 40px; font-weight: bold; color: var(--text-color); }
        .voice-control-section { margin-bottom: 60px; }

        /* TEMA BUTONU (SAÄž ÃœST) */
        .theme-toggle-wrapper {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .btn-theme {
            background: transparent;
            border: 3px solid var(--text-color);
            color: var(--text-color);
            padding: 10px 20px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        .btn-theme:hover {
            background-color: var(--text-color);
            color: var(--bg-color);
        }

        /* BAÅžLANGIÃ‡ PERDESÄ° (Overlay) */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.95);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; cursor: pointer;
        }
        .start-message {
            font-size: 40px; color: #00FF00; font-weight: bold;
            border: 4px solid #00FF00; padding: 50px; border-radius: 20px;
            animation: pulse-border 2s infinite; text-align: center;
        }
        @keyframes pulse-border { 0% {box-shadow: 0 0 0 0 rgba(0,255,0,0.7);} 70% {box-shadow: 0 0 0 20px rgba(0,255,0,0);} 100% {box-shadow: 0 0 0 0 rgba(0,255,0,0);} }

        /* MÄ°KROFON BUTONU */
        .mic-button {
            width: 200px; height: 200px; border-radius: 50%;
            background: linear-gradient(135deg, #FFFF00 0%, #FFD700 100%);
            border: 6px solid var(--mic-border); cursor: pointer; display: flex;
            align-items: center; justify-content: center; margin: 0 auto 30px;
            transition: all 0.3s ease; position: relative;
        }
        /* Light modda mikrofon rengini sabit tutmak daha iyi olabilir veya deÄŸiÅŸtirebiliriz */
        
        .mic-button:hover { transform: scale(1.1); box-shadow: 0 0 40px rgba(255, 255, 0, 0.8); }
        .mic-button:focus { outline: 8px solid var(--focus-color); outline-offset: 8px; box-shadow: 0 0 50px rgba(0, 255, 255, 0.9); }
        .mic-button:active { transform: scale(0.95); }

        .mic-button.listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #00FF00 0%, #00CC00 100%);
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 40px rgba(0, 255, 0, 0.8); }
            50% { box-shadow: 0 0 80px rgba(0, 255, 0, 1); }
        }

        .mic-icon { font-size: 80px; color: #000000; }
        .voice-status { font-size: 28px; color: var(--text-color); font-weight: bold; min-height: 40px; }

        /* FORM ALANLARI */
        .form-section { margin-top: 60px; }
        .input-group { margin-bottom: 40px; }

        label { display: block; font-size: 28px; font-weight: bold; margin-bottom: 15px; text-align: left; color: var(--text-color); }

        input[type="email"],
        input[type="password"] {
            width: 100%; padding: 25px 30px; font-size: 28px;
            background-color: var(--input-bg); color: var(--text-color);
            border: 4px solid var(--border-color); border-radius: 12px; transition: all 0.3s ease;
        }
        input:focus {
            outline: 8px solid var(--focus-color); outline-offset: 4px;
            border-color: var(--focus-color); 
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
        }
        input::placeholder { color: #888888; font-size: 24px; }

        /* BUTONLAR */
        .button-group { display: flex; gap: 30px; margin-top: 50px; flex-wrap: wrap; }

        button.action-btn {
            flex: 1; min-width: 250px; padding: 30px 40px; font-size: 32px;
            font-weight: bold; background-color: var(--button-bg); color: var(--button-text);
            border: 4px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;
        }
        button.action-btn:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(128, 128, 128, 0.5); }
        button.action-btn:focus { outline: 8px solid var(--focus-color); outline-offset: 6px; }

        .secondary-button { background-color: transparent !important; color: var(--text-color) !important; border-color: var(--text-color) !important; }
        .secondary-button:hover { background-color: var(--input-bg) !important; }

        /* BÄ°LDÄ°RÄ°M KUTUSU */
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 30px 40px;
            background-color: #00FF00; color: #000000; font-size: 28px;
            font-weight: bold; border-radius: 12px; border: 4px solid #FFFFFF;
            box-shadow: 0 8px 40px rgba(0, 255, 0, 0.6); opacity: 0;
            transform: translateX(400px); transition: all 0.5s ease; z-index: 1000;
        }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.error { background-color: #FF0000; color: #FFFFFF; }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        @media (max-width: 768px) {
            h1 { font-size: 36px; }
            .mic-button { width: 160px; height: 160px; }
            .mic-icon { font-size: 60px; }
            .button-group { flex-direction: column; }
            button.action-btn { min-width: 100%; }
            .theme-toggle-wrapper { top: 10px; right: 10px; }
        }
    </style>
</head>
<body>

<div class="theme-toggle-wrapper">
    <button id="themeToggle" class="btn-theme" aria-label="TemayÄ± deÄŸiÅŸtir">
        <i class="fas fa-adjust"></i> Tema
    </button>
</div>

<div id="start-overlay" onclick="startApp()">
    <div class="start-message">GÄ°RÄ°Åž EKRANI<br>BAÅžLATMAK Ä°Ã‡Ä°N TIKLAYIN<br>VEYA SPACE'E BASIN</div>
</div>

<a href="#main-content" class="skip-link sr-only">Ana iÃ§eriÄŸe geÃ§</a>

<div class="container" id="main-content" role="main">
    <h1>EchoMarket GiriÅŸ</h1>

    <div class="voice-control-section" role="region" aria-label="Sesli komut bÃ¶lÃ¼mÃ¼">
        <button
                class="mic-button"
                id="micButton"
                aria-label="Sesli komut vermek iÃ§in mikrofon butonuna basÄ±n veya Space tuÅŸuna basÄ±n"
                aria-pressed="false"
                type="button">
            <span class="mic-icon" aria-hidden="true">ðŸŽ¤</span>
        </button>
        <div class="voice-status" id="voiceStatus" aria-live="polite" aria-atomic="true">
            Sesli komut iÃ§in mikrofona basÄ±n
        </div>
    </div>

    <form class="form-section" id="loginForm" novalidate>
        <div class="input-group">
            <label for="email">E-posta Adresi</label>
            <input
                    type="email"
                    id="email"
                    name="email"
                    aria-label="E-posta adresinizi girin"
                    aria-required="true"
                    aria-describedby="email-help"
                    placeholder="ornek@email.com"
                    autocomplete="email">
            <span id="email-help" class="sr-only">E-posta adresinizi eksiksiz girin</span>
        </div>
        <div class="input-group">
            <label for="password">Åžifre</label>
            <input
                    type="password"
                    id="password"
                    name="password"
                    aria-label="Åžifrenizi girin"
                    aria-required="true"
                    aria-describedby="password-help"
                    placeholder="Åžifreniz"
                    autocomplete="current-password">
            <span id="password-help" class="sr-only">Åžifrenizi girin</span>
        </div>

        <div class="button-group">
            <button
                    type="submit"
                    class="action-btn"
                    id="loginButton"
                    aria-label="GiriÅŸ yap butonuna tÄ±klayÄ±n">
                GiriÅŸ Yap
            </button>
            <button
                    type="button"
                    class="action-btn secondary-button"
                    id="registerButton"
                    aria-label="Yeni hesap oluÅŸtur">
                KayÄ±t Ol
            </button>
        </div>
    </form>
</div>

<div class="notification" id="notification" role="alert" aria-live="assertive"></div>

<script>


    // --- MEVCUT JS KODLARI ---
    const micButton = document.getElementById('micButton');
    const voiceStatus = document.getElementById('voiceStatus');
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const notification = document.getElementById('notification');
    const loginButton = document.getElementById('loginButton');
    const registerButton = document.getElementById('registerButton');
    const overlay = document.getElementById('start-overlay');

    let isListening = false;

    // --- BAÅžLATMA FONKSÄ°YONU ---
    function startApp() {
        overlay.style.display = 'none';
        // Otomatik baÅŸlat ve ne yapmasÄ± gerektiÄŸini sÃ¶yle
        speak("GiriÅŸ ekranÄ±ndasÄ±nÄ±z. LÃ¼tfen e-posta adresinizi sÃ¶yleyin.", true);
    }

    // --- YARDIMCI: YazÄ± rakamlarÄ±nÄ± sayÄ±ya Ã§evir ---
    function textToNumbers(text) {
        const numbers = {
            'bir': '1', 'iki': '2', 'Ã¼Ã§': '3', 'dÃ¶rt': '4', 'beÅŸ': '5',
            'altÄ±': '6', 'yedi': '7', 'sekiz': '8', 'dokuz': '9', 'sÄ±fÄ±r': '0'
        };
        return text.split(' ').map(word => numbers[word] || word).join(' ');
    }

    // --- SESLÄ° GERÄ° BÄ°LDÄ°RÄ°M (TTS) ---
    function speak(text, autoListen = false) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'tr-TR';
        utterance.rate = 0.9;
        utterance.volume = 1;

        utterance.onend = function() {
            if (autoListen) {
                startListening();
            }
        };

        window.speechSynthesis.speak(utterance);
    }

    // --- GÃ–RSEL BÄ°LDÄ°RÄ°M ---
    function showNotification(message, isError = false) {
        notification.textContent = message;
        notification.className = 'notification show' + (isError ? ' error' : '');
        setTimeout(() => notification.classList.remove('show'), 4000);
    }

    // --- MÄ°KROFON YÃ–NETÄ°MÄ° ---
    function startListening() {
        if(isListening) return;
        isListening = true;
        micButton.classList.add('listening');
        voiceStatus.textContent = "Dinliyorum...";
        showNotification('Dinliyorum...');
        setTimeout(listen, 500);
    }

    function stopListening() {
        isListening = false;
        micButton.classList.remove('listening');
        voiceStatus.textContent = 'Sesli komut iÃ§in mikrofona basÄ±n';
    }

    function toggleVoiceCommand() {
        if (isListening) {
            stopListening();
            speak("Ä°ptal edildi.");
            return;
        }
        speak("Dinliyorum.", true);
    }

    // --- ANA MANTIK ---
    async function listen() {
        if (!isListening) return;

        try {
            const response = await fetch('/dinle', { method: 'POST' });
            const data = await response.json();

            if (data.status === 'success') {
                let rawCommand = data.command.toLowerCase().trim();
                showNotification(`Duyulan: "${rawCommand}"`);
                console.log("Ham Veri:", rawCommand);

                // 1. Ã–NCELÄ°K: SÄ°LME (YANLIÅžSA SÄ°L DEYÄ°N KISMI)
                if (rawCommand.includes('yanlÄ±ÅŸ') || rawCommand.includes('sil') || rawCommand.includes('temizle') || rawCommand.includes('hayÄ±r')) {
                    emailInput.value = "";
                    passwordInput.value = "";
                    showNotification("Temizlendi.");
                    // HATA DÃœZELTME MESAJI:
                    speak("Alanlar temizlendi. LÃ¼tfen e-postanÄ±zÄ± tekrar sÃ¶yleyin.", true);
                    return;
                }

                // 2. Ã–NCELÄ°K: BUTONLAR
                if (rawCommand.includes('giriÅŸ yap')) {
                    speak("GiriÅŸ yapÄ±lÄ±yor.");
                    setTimeout(() => loginButton.click(), 500);
                    return;
                }
                if (rawCommand.includes('kayÄ±t ol')) {
                    speak("KayÄ±t sayfasÄ±na gidiliyor.");
                    setTimeout(() => registerButton.click(), 500);
                    return;
                }

                // 3. Ã–NCELÄ°K: E-POSTA
                let processedText = rawCommand
                    .replace(/^(email yaz|e-posta yaz|posta yaz)/g, '')
                    .replace(/(?:\s|^)(nokta|dÄ±t|dat|dot)(?:\s|$)/g, '.')
                    .replace(/(?:\s|^)(et|at)(?:\s|$)/g, '@')
                    .replace(/\s+/g, '');

                const trMap = {'ÄŸ':'g', 'Ã¼':'u', 'ÅŸ':'s', 'Ä±':'i', 'Ã¶':'o', 'Ã§':'c'};
                let emailCandidate = processedText.replace(/[ÄŸÃ¼ÅŸÄ±Ã¶Ã§]/g, s => trMap[s]);

                if (emailCandidate.includes('@') || emailCandidate.includes('gmail') || emailCandidate.includes('hotmail') || emailCandidate.includes('.com')) {
                    if (!emailCandidate.includes('@')) {
                        if (emailCandidate.includes('gmail')) emailCandidate = emailCandidate.replace('gmail', '@gmail');
                        if (emailCandidate.includes('hotmail')) emailCandidate = emailCandidate.replace('hotmail', '@hotmail');
                    }
                    emailInput.value = emailCandidate;
                    emailInput.focus();

                    let readableEmail = emailCandidate.replace('@', ' et ').replace(/\./g, ' nokta ');

                    // TEYÄ°T MESAJI:
                    speak(`E-posta: ${readableEmail}. DoÄŸruysa ÅŸifreyi sÃ¶yleyin, yanlÄ±ÅŸsa sil deyin.`, true);
                }

                // 4. Ã–NCELÄ°K: ÅžÄ°FRE
                else {
                    let passText = rawCommand.replace(/^(ÅŸifre yaz|parola yaz|ÅŸifre|parola)/g, '').trim();
                    passText = textToNumbers(passText).replace(/\s+/g, '');

                    if (passText.length > 0) {
                        passwordInput.value = passText;
                        passwordInput.focus();

                        // TEYÄ°T MESAJI:
                        speak("Åžifre girildi. DoÄŸruysa giriÅŸ yap deyin, yanlÄ±ÅŸsa sil deyin.", true);
                    } else {
                        speak("AnlaÅŸÄ±lamadÄ±. Tekrar sÃ¶yleyin.", true);
                    }
                }

            } else {
                speak("Ses gelmedi.", false);
                stopListening();
            }

        } catch (error) {
            console.error('Hata:', error);
            speak("Bir hata oluÅŸtu.");
            stopListening();
        }
    }

    // --- KLAVYE KONTROLÃœ (SPACE DÃœZELTMESÄ°) ---
    micButton.addEventListener('click', toggleVoiceCommand);

    document.addEventListener('keydown', (e) => {
        // Space tuÅŸunu yakala
        if (e.code === 'Space' || e.key === ' ') {

            // EÄŸer odak input alanÄ±ndaysa Space normal Ã§alÄ±ÅŸsÄ±n
            if (document.activeElement.tagName === 'INPUT') {
                return;
            }

            e.preventDefault(); // Sayfa kaymasÄ±nÄ± engelle

            if(overlay.style.display !== 'none') {
                startApp();
            } else {
                toggleVoiceCommand();
            }
        }
    });

    // --- KAYIT OL BUTONU YÃ–NLENDÄ°RMESÄ° ---
    registerButton.addEventListener('click', () => {
        speak("KayÄ±t sayfasÄ±na gidiliyor.");
        setTimeout(() => {
            window.location.href = "/register";
        }, 1000);
    });

    // --- FORM GÃ–NDERME (BACKEND BAÄžLANTILI) ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || !password) {
            speak("LÃ¼tfen e-posta ve ÅŸifreyi doldurun.");
            return;
        }

        speak("GiriÅŸ yapÄ±lÄ±yor, lÃ¼tfen bekleyin.");

        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, password: password })
            });

            const result = await response.json();

            if (result.status === 'success') {
                // DÃœZELTME: /market sayfasÄ±na yÃ¶nlendir
                speak("GiriÅŸ baÅŸarÄ±lÄ±! Market sayfasÄ±na yÃ¶nlendiriliyorsunuz.");
                showNotification("GiriÅŸ BaÅŸarÄ±lÄ±!");
                setTimeout(() => window.location.href = "/market", 2000);
            } else {
                // HATA DURUMU
                speak("GirdiÄŸiniz bilgiler yanlÄ±ÅŸtÄ±r. LÃ¼tfen tekrar deneyin.");
                showNotification("HATA: " + result.message, true);

                emailInput.value = "";
                passwordInput.value = "";
                emailInput.focus();
            }

        } catch (error) {
            console.error('Hata:', error);
            speak("Sunucuya baÄŸlanÄ±lamadÄ±.");
            showNotification("BaÄŸlantÄ± HatasÄ±", true);
        }
    });
</script>
<script src="{{ url_for('static', filename='theme.js') }}"></script>
</body>
</html>
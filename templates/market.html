<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoMarket - AlÄ±ÅŸveriÅŸ</title>
    <style>
        body { background-color: #000000; color: #FFFF00; font-family: 'Arial', sans-serif; margin: 0; padding: 20px; text-align: center; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid #333; margin-bottom: 30px; }
        h1 { font-size: 40px; margin: 0; }

        .mic-container { margin: 30px 0; }
        .mic-button { width: 120px; height: 120px; border-radius: 50%; background: #FFFF00; border: 6px solid #fff; font-size: 50px; cursor: pointer; transition: all 0.3s; }
        .mic-button.listening { background: #00FF00; box-shadow: 0 0 40px #00FF00; transform: scale(1.1); }
        #status { font-size: 24px; margin-top: 15px; color: #fff; }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; padding: 20px; }

        .product-card { position: relative; background: #1A1A1A; border: 4px solid #FFFF00; border-radius: 20px; padding: 20px; text-align: center; transition: transform 0.3s; }
        .product-card:hover { transform: scale(1.05); border-color: #00FFFF; }

        .card-number {
            position: absolute; top: -20px; left: -20px; width: 60px; height: 60px;
            background: #00FF00; color: #000; font-size: 32px; font-weight: bold;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 4px solid #fff; z-index: 10;
        }

        .product-img { width: 100%; height: 250px; object-fit: contain; background-color: #fff; border-radius: 10px; margin-bottom: 15px; }
        .product-name { font-size: 32px; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .product-price { font-size: 36px; color: #00FF00; font-weight: bold; }

        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .start-msg { font-size: 48px; color: #00FF00; border: 5px solid #00FF00; padding: 40px; border-radius: 20px; }
    </style>
</head>
<body>

<div id="start-overlay" onclick="startApp()">
    <div class="start-msg">MARKETÄ° BAÅžLATMAK Ä°Ã‡Ä°N<br>TIKLAYIN</div>
</div>

<header>
    <h1>EchoMarket</h1>
    <div style="font-size: 24px;">ðŸ‘¤ HesabÄ±m</div>
</header>

<div class="mic-container">
    <button id="micButton" class="mic-button">ðŸŽ¤</button>
    <div id="status">Mikrofona basÄ±n</div>
</div>

<div id="productsContainer" class="products-grid">
    <div style="grid-column: 1/-1; font-size: 28px; color: #888;">
        "DuÅŸ jeli", "SÃ¼t", "Ekmek" gibi bir Ã¼rÃ¼n sÃ¶yleyin...
    </div>
</div>

<script>
    const micButton = document.getElementById('micButton');
    const statusDiv = document.getElementById('status');
    const container = document.getElementById('productsContainer');
    const overlay = document.getElementById('start-overlay');

    let isListening = false;
    let currentState = "SEARCH";
    let currentQuery = "";
    let currentOffset = 0;
    let currentProducts = [];

    function startApp() {
        overlay.style.display = 'none';
        speak("Echo Market'e hoÅŸ geldiniz. BugÃ¼n neler almak istersiniz?", true);
    }

    function speak(text, autoListen = false) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'tr-TR'; u.rate = 0.9;

        u.onend = function() { if (autoListen) setTimeout(() => toggleMic(true), 900); };
        window.speechSynthesis.speak(u);
    }

    function toggleMic(forceStart = false) {
        if (!forceStart && isListening) {
            isListening = false; micButton.classList.remove('listening');
            statusDiv.textContent = "Mikrofona basÄ±n";
            return;
        }

        isListening = true;
        micButton.classList.add('listening');
        statusDiv.textContent = "Dinliyorum...";
        listen();
    }

    async function listen() {
        if (!isListening) return;

        try {
            const res = await fetch('/dinle', { method: 'POST' });
            const data = await res.json();

            if (data.status === 'success') {
                let command = data.command.toLowerCase().trim();
                statusDiv.textContent = "AlgÄ±landÄ±: " + command;

                /* -------------------------------------------------------------------
                   ðŸ”¥ DÃœZELTÄ°LMÄ°Åž SEÃ‡Ä°M BLOÄžU (KELÄ°ME TEMÄ°Z EÅžLEÅžME)
                -------------------------------------------------------------------*/

                if (currentState === "SELECTION") {

                    const sayiKelimeleri = {
                        0: ["bir","1","ilk"],
                        1: ["iki","2"],
                        2: ["Ã¼Ã§","3"],
                        3: ["dÃ¶rt","4"]
                    };

                    // Ã¶nce hiÃ§biri kontrolÃ¼ â€” artÄ±k ASLA yanlÄ±ÅŸ tetiklenmez
                    const hicbiriMi =
                        command.includes("hiÃ§biri") ||
                        command.includes("hiÃ§ biri") ||
                        command.includes("hiÃ§ birini") ||
                        command.includes("sonraki") ||
                        command.includes("devam") ||
                        command.includes("geÃ§");

                    if (hicbiriMi) {
                        currentOffset += 4;
                        searchProducts(currentQuery, currentOffset);
                        return;
                    }

                    // sayÄ± kelimelerini parÃ§alarsÄ±n â€” tek kelime eÅŸleÅŸmesi
                    let selectedIndex = -1;
                    const kelimeler = command.split(" ");

                    kelimeler.forEach(k => {
                        Object.entries(sayiKelimeleri).forEach(([index, list]) => {
                            list.forEach(x => {
                                if (k === x) selectedIndex = Number(index);
                            });
                        });
                    });

                    if (selectedIndex !== -1 && currentProducts[selectedIndex]) {
                        addToCart(currentProducts[selectedIndex]);
                        return;
                    }

                    speak("AnlayamadÄ±m. NumarayÄ± sÃ¶yleyin veya 'hiÃ§biri' deyin.", true);
                    return;
                }

                /* --- ARAMA MODU --- */
                if (currentState === "SEARCH") {
                    currentQuery = command;
                    currentOffset = 0;
                    searchProducts(currentQuery, currentOffset);
                }

            } else {
                speak("Ses anlaÅŸÄ±lmadÄ±.", false);
                isListening = false;
                micButton.classList.remove('listening');
            }

        } catch (e) { speak("Bir hata oluÅŸtu."); }

        isListening = false;
        micButton.classList.remove('listening');
    }

    async function searchProducts(query, offset) {
        if (offset === 0) speak(query + " aranÄ±yor...", false);

        try {
            const res = await fetch('/search_products', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query, offset: offset })
            });
            const result = await res.json();

            if (result.status === 'success') {
                currentState = "SELECTION";
                currentProducts = result.products;
                displayProducts(result.products);
            } else if (result.status === 'empty') {
                if (offset > 0) {
                    speak("BaÅŸka Ã¼rÃ¼n yok. BaÅŸtan baÅŸlÄ±yorum.", true);
                    currentOffset = 0;
                    searchProducts(query, 0);
                } else {
                    speak("ÃœrÃ¼n bulunamadÄ±. BaÅŸka bir ÅŸey sÃ¶yleyin.", true);
                    currentState = "SEARCH";
                }
            }
        } catch (e) { speak("Arama hatasÄ±."); }
    }

    async function addToCart(product) {
        speak(product.name + " sepete ekleniyor...");
        try {
            const res = await fetch('/add_to_cart', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(product)
            });
            const result = await res.json();

            if (result.status === 'success') {
                speak(product.name + " sepete eklendi. BaÅŸka bir Ã¼rÃ¼n sÃ¶yleyin.", true);
                currentState = "SEARCH";
            }
        } catch (e) { speak("Sepet hatasÄ±."); }
    }

    function displayProducts(products) {
        container.innerHTML = "";
        let speechText = "Ä°ÅŸte Ã¼rÃ¼nler: ";

        products.forEach((prod, index) => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <div class="card-number">${index + 1}</div>
                <img src="${prod.image}" class="product-img" onerror="this.src='https://placehold.co/400?text=Resim+Yok'">
                <div class="product-name">${prod.name}</div>
                <div class="product-price">${prod.price} TL</div>
            `;
            container.appendChild(card);

            speechText += `${index + 1}. ${prod.name}, ${Math.floor(prod.price)} lira. `;
        });

        speechText += "Hangisini ekleyelim? NumarayÄ± sÃ¶yleyin veya 'hiÃ§biri' deyin.";
        speak(speechText, true);
    }

    micButton.addEventListener('click', () => toggleMic());
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            e.preventDefault();
            if (overlay.style.display !== 'none') startApp();
            else toggleMic();
        }
    });
</script>

</body>
</html>

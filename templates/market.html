<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoMarket - Alışveriş</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- TEMA DEĞİŞKENLERİ --- */
        :root {
            /* Varsayılan (Dark Mode) */
            --bg-color: #000000;
            --text-color: #FFFF00;
            --card-bg: #1A1A1A;
            --card-border: #FFFF00;
            --accent-color: #00FF00; /* Yeşil vurgular */
            --header-border: #333;
            --mic-bg: #FFFF00;
            --mic-border: #FFFFFF;
            --status-color: #FFFFFF;
        }

        /* Light Mode Ayarları */
        body.light-mode {
            --bg-color: #FFFFFF;
            --text-color: #000000;
            --card-bg: #F0F0F0;
            --card-border: #000000;
            --accent-color: #00AA00; /* Koyu yeşil */
            --header-border: #CCC;
            --mic-bg: #FFD700;
            --mic-border: #000000;
            --status-color: #000000;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Arial', sans-serif;
            margin: 0; padding: 20px; text-align: center;
            transition: background-color 0.3s, color 0.3s;
        }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 20px; border-bottom: 2px solid var(--header-border);
            margin-bottom: 30px;
        }
        h1 { font-size: 40px; margin: 0; }

        .mic-container { margin: 30px 0; }
        .mic-button {
            width: 120px; height: 120px; border-radius: 50%;
            background: var(--mic-bg);
            border: 6px solid var(--mic-border);
            font-size: 50px; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; margin: 0 auto;
        }
        .mic-button.listening { background: var(--accent-color); box-shadow: 0 0 40px var(--accent-color); transform: scale(1.1); }

        #status { font-size: 24px; margin-top: 15px; color: var(--status-color); }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; padding: 20px; }

        .product-card {
            position: relative;
            background: var(--card-bg);
            border: 4px solid var(--card-border);
            border-radius: 20px; padding: 20px; text-align: center; transition: transform 0.3s;
        }
        .product-card:hover { transform: scale(1.05); border-color: #00FFFF; }

        .card-number {
            position: absolute; top: -20px; left: -20px; width: 60px; height: 60px;
            background: var(--accent-color); color: #000; font-size: 32px; font-weight: bold;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 4px solid #fff; z-index: 10;
        }

        .product-img { width: 100%; height: 250px; object-fit: contain; background-color: #fff; border-radius: 10px; margin-bottom: 15px; }
        .product-name { font-size: 32px; font-weight: bold; margin-bottom: 10px; color: var(--text-color); }
        .product-price { font-size: 36px; color: var(--accent-color); font-weight: bold; }

        /* Başlangıç Ekranı */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 9999;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .start-msg { font-size: 48px; color: #00FF00; border: 5px solid #00FF00; padding: 40px; border-radius: 20px; }

        /* Linkler */
        .nav-link { color: var(--text-color); text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .nav-link:hover { color: var(--accent-color); }

        /* Tema Butonu */
        .theme-btn {
            padding: 10px 20px; font-size: 18px; border-radius: 10px;
            border: 3px solid var(--text-color);
            background: transparent; color: var(--text-color); cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
    </style>
</head>
<body>

<div id="start-overlay" onclick="startApp()">
    <div class="start-msg">MARKETİ BAŞLATMAK İÇİN<br>TIKLAYIN</div>
</div>

<header>
    <h1>EchoMarket</h1>
    <div style="display:flex; gap:20px; align-items:center; font-size:24px;">
        <a href="/account" class="nav-link"><i class="fas fa-user"></i> Hesabım</a>
        <a href="/cart" class="nav-link"><i class="fas fa-shopping-cart"></i> Sepetim (<span id="cartCount">{{ cart_count }}</span>)</a>

        <button id="themeToggle" class="theme-btn">
            <i class="fas fa-adjust"></i> Tema
        </button>
    </div>
</header>

<div class="mic-container">
    <button id="micButton" class="mic-button"><i class="fas fa-microphone"></i></button>
    <div id="status">Mikrofona basın</div>
</div>

<div id="productsContainer" class="products-grid">
</div>

<script>
    const micButton = document.getElementById('micButton');
    const statusDiv = document.getElementById('status');
    const container = document.getElementById('productsContainer');
    const overlay = document.getElementById('start-overlay');
    const cartCountSpan = document.getElementById('cartCount');

    let isListening = false;
    let currentState = "MAIN_MENU";
    let currentQuery = "";
    let currentOffset = 0;
    let currentProducts = [];

    function showMainMenuUI() {
        // Renk kodunu kaldırdık, CSS class kullanıyoruz veya inherit ediyoruz
        container.innerHTML = `
            <div style="grid-column: 1 / -1; font-size: 28px; opacity: 0.8; margin-top: 50px;">
                Ana menüdesiniz.<br><br>
                "Ürün al", "sepete bak" veya "hesabım" diyebilirsiniz.
            </div>
        `;
    }

    function startApp() {
        overlay.style.display = 'none';
        currentState = "MAIN_MENU";
        showMainMenuUI();
        speak("Ana menüdesiniz. Ürün almak için 'ürün al', sepet için 'sepete bak', hesabım için 'hesabım' diyebilirsiniz.", true);
    }

    function speak(text, autoListen = false) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'tr-TR'; u.rate = 0.9;
        u.onend = function() { if (autoListen) setTimeout(() => toggleMic(true), 900); };
        window.speechSynthesis.speak(u);
    }

    function toggleMic(forceStart = false) {
        if (!forceStart && isListening) {
            isListening = false; micButton.classList.remove('listening');
            statusDiv.textContent = "Mikrofona basın";
            return;
        }
        isListening = true; micButton.classList.add('listening');
        statusDiv.textContent = "Dinliyorum...";
        listen();
    }

    async function listen() {
        if (!isListening) return;

        try {
            const res = await fetch('/dinle', { method: 'POST' });
            const data = await res.json();

            if (data.status !== 'success') {
                speak("Ses anlaşılmadı.", true);
                return;
            }

            if (data.state) currentState = data.state;

            if (currentState === "OPEN_CART") {
                speak("Sepetinizi açıyorum.");
                setTimeout(() => { window.location.href = "/cart"; }, 1500);
                return;
            }
            if (currentState === "ACCOUNT") {
                speak("Hesabınıza gidiyorum.");
                setTimeout(() => { window.location.href = "/account"; }, 1500);
                return;
            }

            if (data.message) speak(data.message, true);

            if (currentState === "LIST_PRODUCTS" && data.query) {
                currentQuery = data.query;
                currentOffset = 0;
                searchProducts(currentQuery, currentOffset);
                return;
            }

            // Command verisini backend düzeltmesinden sonra alıyoruz
            const command = (data.command || "").toLowerCase().trim();
            statusDiv.textContent = "Algılandı: " + command;

            if (currentState === "SELECTION") {
                if (command.includes("ana menü") || command.includes("başa dön")) {
                    currentState = "MAIN_MENU";
                    showMainMenuUI();
                    speak("Ana menüdesiniz.", true);
                    return;
                }

                if (command.includes("devam") || command.includes("sonraki") || command.includes("hiçbiri")) {
                    currentOffset += 6;
                    searchProducts(currentQuery, currentOffset);
                    return;
                }

                const sayiKelimeleri = {
                    0: ["bir", "1", "ilk", "birinci"],
                    1: ["iki", "2", "ikinci"],
                    2: ["üç", "3", "üçüncü"],
                    3: ["dört", "4", "dördüncü"],
                    4: ["beş", "5", "beşinci"],
                    5: ["altı", "6", "altıncı"]
                };

                let selectedIndex = -1;
                command.split(" ").forEach(k => {
                    Object.entries(sayiKelimeleri).forEach(([i, list]) => {
                        if (list.includes(k)) selectedIndex = Number(i);
                    });
                });

                if (selectedIndex !== -1 && currentProducts[selectedIndex]) {
                    addToCart(currentProducts[selectedIndex]);
                    return;
                }
            }

        } catch (e) {
            console.error(e);
            speak("Bir hata oluştu.", true);
        } finally {
            isListening = false;
            micButton.classList.remove('listening');
        }
    }

    async function searchProducts(query, offset) {
        if (offset === 0) speak(query + " aranıyor...", false);

        try {
            const res = await fetch('/search_products', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query, offset: offset })
            });
            const result = await res.json();

            if (result.status === 'success') {
                currentState = "SELECTION";
                currentProducts = result.products;
                displayProducts(result.products);
            } else if (result.status === 'empty') {
                if (offset > 0) {
                    speak("Başka ürün yok. Baştan başlıyorum.", true);
                    currentOffset = 0;
                    searchProducts(query, 0);
                } else {
                    speak("Ürün bulunamadı. Başka bir şey söyleyin.", true);
                    currentState = "SEARCH";
                }
            }
        } catch (e) { speak("Arama hatası."); }
    }

    async function addToCart(product) {
        speak(product.name + " sepete ekleniyor...");

        const res = await fetch('/add_to_cart', {
            method: "POST",
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ product_id: product.id, quantity: 1 })
        });

        const data = await res.json();
        if(data.status === 'success') {
            if(data.cart_count !== undefined) {
                cartCountSpan.innerText = data.cart_count;
            }
            speak("Eklendi. Başka bir ürün seçebilir veya ana menüye dönebilirsiniz.", true);
        } else {
            speak("Hata oluştu.", true);
        }
    }

    function displayProducts(products) {
        container.innerHTML = "";
        let speechText = "İşte ürünler: ";

        products.forEach((prod, index) => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <div class="card-number">${index + 1}</div>
                <img src="${prod.image}" class="product-img" onerror="this.src='https://placehold.co/400?text=Resim+Yok'">
                <div class="product-name">${prod.name}</div>
                <div class="product-price">${prod.price} TL</div>
            `;
            container.appendChild(card);
            speechText += `${index + 1}. ${prod.name}, ${Math.floor(prod.price)} lira. `;
        });

        speechText += "Hangisini ekleyelim? Numarayı söyleyin.";
        speak(speechText, true);
    }

    micButton.addEventListener('click', () => toggleMic());
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            e.preventDefault();
            if (overlay.style.display !== 'none') startApp();
            else toggleMic();
        }
    });

</script>

<script src="{{ url_for('static', filename='theme.js') }}"></script>

</body>
</html>
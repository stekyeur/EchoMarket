{% extends "layout.html" %}

{% block styles %}
<style>
    /* --- MARKET SAYFASINA Ã–ZEL STÄ°LLER --- */

    /* Ãœst Bar (Sepet Linki iÃ§in) */
    .top-bar {
        display: flex; justify-content: flex-end; padding: 10px 20px;
    }
    .cart-link {
        color: var(--accent-color); text-decoration: none; font-size: 20px; 
        font-weight: bold; border: 2px solid var(--accent-color); 
        padding: 8px 15px; border-radius: 10px; transition: 0.3s;
    }
    .cart-link:hover { background: var(--accent-color); color: #000; }

    /* Overlay */
    #start-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.95); z-index: 9999; 
        display: flex; align-items: center; justify-content: center; cursor: pointer; 
    }
    .start-msg { 
        font-size: 48px; color: var(--accent-color); border: 5px solid var(--accent-color); 
        padding: 40px; border-radius: 20px; text-align: center;
    }

    /* Arama Kutusu */
    .search-input-container {
        width: 90%; max-width: 600px; display: flex; gap: 10px; margin: 20px auto;
    }
    .search-input {
        flex: 1; padding: 15px; font-size: 18px; border-radius: 10px;
        border: 2px solid #555; background-color: var(--input-bg); color: var(--text-color);
    }
    .search-btn {
        padding: 0 25px; font-size: 18px; background-color: var(--accent-color);
        color: var(--bg-color); border: none; border-radius: 10px; cursor: pointer; font-weight: bold;
    }

    /* Mikrofon */
    .mic-container { margin: 20px 0; display: flex; flex-direction: column; align-items: center; }
    .mic-button { 
        width: 100px; height: 100px; border-radius: 50%; 
        background: var(--accent-color); border: 4px solid var(--text-color); 
        font-size: 40px; cursor: pointer; transition: all 0.3s; 
        display: flex; align-items: center; justify-content: center; color: var(--bg-color);
    }
    .mic-button.listening { 
        background: #00FF00; box-shadow: 0 0 30px #00FF00; transform: scale(1.1); border-color: #fff;
    }
    #status { font-size: 20px; margin-top: 15px; color: var(--text-color); font-weight: bold; }

    /* ÃœrÃ¼n KartlarÄ± */
    .products-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 95%; margin: 0 auto; }
    .product-card { 
        position: relative; background: var(--card-bg); border: 3px solid var(--accent-color); 
        border-radius: 15px; padding: 15px; text-align: center; transition: transform 0.3s; 
        display: flex; flex-direction: column; justify-content: space-between;
    }
    .product-card:hover { transform: scale(1.03); border-color: #00FFFF; }

    .card-number {
        position: absolute; top: -15px; left: -15px; width: 50px; height: 50px;
        background: #00FF00; color: #000; font-size: 28px; font-weight: bold;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        border: 3px solid #fff; z-index: 10;
    }
    .product-img { width: 100%; height: 200px; object-fit: contain; background-color: #fff; border-radius: 8px; margin-bottom: 10px; }
    .product-name { font-size: 22px; font-weight: bold; margin-bottom: 5px; color: var(--text-color); min-height: 60px; display: flex; align-items: center; justify-content: center;}
    .product-price { font-size: 26px; color: var(--accent-color); font-weight: bold; margin-bottom: 15px; }

    /* Sepete Ekle Butonu */
    .add-btn {
        width: 100%; padding: 10px; background: var(--text-color); color: var(--bg-color);
        font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;
    }
    .add-btn:hover { background: #00FF00; }

    /* Sayfalama */
    .pagination { display: flex; justify-content: center; gap: 20px; margin: 40px 0; display: none; }
    .page-btn {
        padding: 10px 25px; background: var(--card-bg); border: 2px solid var(--accent-color);
        color: var(--text-color); font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 18px;
    }
    .page-btn:hover:not(:disabled) { background: var(--accent-color); color: #000; }
    .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

</style>
{% endblock %}

{% block content %}

    <div class="top-bar">
        <a href="/cart" class="cart-link"><i class="fas fa-shopping-cart"></i> Sepetim</a>
    </div>

    <div id="start-overlay" onclick="startApp()">
        <div class="start-msg">MARKETÄ° BAÅžLATMAK Ä°Ã‡Ä°N<br>TIKLAYIN</div>
    </div>

    <div class="search-input-container">
        <input type="text" id="text-input" class="search-input" placeholder="ÃœrÃ¼n adÄ± yazÄ±n (Ã¶rn: SÃ¼t)..." onkeypress="handleEnter(event)">
        <button class="search-btn" onclick="textSearch()">ARA</button>
    </div>

    <div class="mic-container">
        <button id="micButton" class="mic-button">ðŸŽ¤</button>
        <div id="status">Mikrofona basÄ±n veya yukarÄ±ya yazÄ±n</div>
    </div>

    <div id="productsContainer" class="products-grid">
        <div style="grid-column: 1/-1; font-size: 24px; color: var(--text-color); opacity: 0.7; text-align: center;">
            "DuÅŸ jeli", "SÃ¼t", "Ekmek" gibi bir Ã¼rÃ¼n sÃ¶yleyin...
        </div>
    </div>

    <div class="pagination" id="pagination">
        <button id="prevBtn" class="page-btn" onclick="prevPage()" disabled>Ã–nceki</button>
        <button id="nextBtn" class="page-btn" onclick="nextPage()">Sonraki</button>
    </div>

{% endblock %}

{% block scripts %}
<script>
    const micButton = document.getElementById('micButton');
    const statusDiv = document.getElementById('status');
    const container = document.getElementById('productsContainer');
    const overlay = document.getElementById('start-overlay');
    const textInput = document.getElementById('text-input');
    const pagination = document.getElementById('pagination');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    let isListening = false;
    let currentState = "SEARCH"; 
    let currentQuery = "";
    let currentOffset = 0;
    let currentProducts = [];

    function startApp() {
        overlay.style.display = 'none';
        speak("Echo Market'e hoÅŸ geldiniz. BugÃ¼n neler almak istersiniz?", true);
    }

    function speak(text, autoListen = false) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'tr-TR'; u.rate = 1.0; 
        u.onend = function() { if (autoListen) setTimeout(() => toggleMic(true), 500); };
        window.speechSynthesis.speak(u);
    }

    function handleEnter(event) { if (event.key === 'Enter') textSearch(); }

    function textSearch() {
        const query = textInput.value;
        if (!query) return;
        statusDiv.textContent = "AranÄ±yor: " + query;
        if (isListening) toggleMic(false); 
        
        currentState = "SEARCH";
        currentQuery = query;
        currentOffset = 0;
        searchProducts(currentQuery, 0);
    }

    // --- SAYFALAMA ---
    function nextPage() {
        currentOffset += 4;
        searchProducts(currentQuery, currentOffset, false);
    }
    function prevPage() {
        if(currentOffset >= 4) {
            currentOffset -= 4;
            searchProducts(currentQuery, currentOffset, false);
        }
    }

    function toggleMic(forceStart = false) {
        if (!forceStart && isListening) {
            isListening = false; micButton.classList.remove('listening');
            statusDiv.textContent = "Mikrofona basÄ±n";
            return;
        }
        isListening = true;
        micButton.classList.add('listening');
        statusDiv.textContent = "Dinliyorum...";
        listen();
    }

    async function listen() {
        if (!isListening) return;
        try {
            const res = await fetch('/dinle', { method: 'POST' });
            const data = await res.json();

            if (data.status === 'success') {
                let command = data.command.toLowerCase().trim();
                statusDiv.textContent = "AlgÄ±landÄ±: " + command;
                textInput.value = command; 

                // --- 1. Ã–NCELÄ°K: YÃ–NLENDÄ°RME (Redirect) KONTROLÃœ ---
                if (data.action === 'redirect' && data.redirect_url) {
                    speak(data.message); // Ã–rn: "Sepete gidiliyor"
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 1500); // KullanÄ±cÄ± mesajÄ± duysun diye 1.5 sn bekle
                    return; // Fonksiyondan Ã§Ä±k, baÅŸka iÅŸlem yapma
                }

                // --- 2. SAYFALAMA ---
                if (command.includes("sonraki") || command.includes("ileri")) { nextPage(); return; }
                if (command.includes("Ã¶nceki") || command.includes("geri")) { prevPage(); return; }

                // --- 3. NUMARA Ä°LE ÃœRÃœN SEÃ‡Ä°MÄ° ---
                if (currentState === "SELECTION") {
                    const numbers = {0:["bir","1"], 1:["iki","2"], 2:["Ã¼Ã§","3"], 3:["dÃ¶rt","4"]};
                    let selected = -1;
                    const words = command.split(" ");
                    words.forEach(w => {
                        Object.entries(numbers).forEach(([idx, arr]) => {
                            if(arr.includes(w)) selected = Number(idx);
                        });
                    });

                    if (selected !== -1 && currentProducts[selected]) {
                        addToCart(currentProducts[selected]);
                        return;
                    }
                }

                // --- 4. ÃœRÃœN ARAMA ---
                // EÄŸer yukarÄ±daki Ã¶zel komutlardan biri deÄŸilse, bunu Ã¼rÃ¼n adÄ± kabul et ve ara
                if (currentState === "SEARCH" || currentState === "SELECTION") {
                    currentQuery = command;
                    currentOffset = 0;
                    searchProducts(currentQuery, 0);
                }
            } else {
                statusDiv.textContent = "Tekrar deneyin...";
                if(isListening) toggleMic(false); 
            }
        } catch (e) { 
            console.error(e); speak("BaÄŸlantÄ± hatasÄ±."); isListening = false; micButton.classList.remove('listening');
        }
    }

    async function searchProducts(query, offset, shouldSpeak = true) {
        if (offset === 0 && shouldSpeak) speak(query + " aranÄ±yor...", false);
        try {
            const res = await fetch('/search_products', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query, offset: offset })
            });
            const result = await res.json();

            if (result.status === 'success') {
                currentState = "SELECTION";
                currentProducts = result.products;
                displayProducts(result.products, shouldSpeak);
                
                // ButonlarÄ± gÃ¼ncelle
                pagination.style.display = 'flex';
                prevBtn.disabled = (offset === 0);
                nextBtn.disabled = (result.products.length < 4);

            } else if (result.status === 'empty') {
                if (offset > 0) {
                    speak("BaÅŸka Ã¼rÃ¼n yok.", true);
                    nextBtn.disabled = true;
                } else {
                    speak("ÃœrÃ¼n bulunamadÄ±.", true);
                    container.innerHTML = "<p>ÃœrÃ¼n bulunamadÄ±.</p>";
                    pagination.style.display = 'none';
                }
            }
        } catch (e) { speak("Arama hatasÄ±."); }
    }

    async function addToCart(product) {
        speak(product.name + " sepete ekleniyor...");
        try {
            const res = await fetch('/add_to_cart', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ product_id: product.id }) 
            });
            const result = await res.json();
            if (result.status === 'success') {
                speak("Eklendi. BaÅŸka ne istersiniz?", true);
                textInput.value = ""; 
            } else {
                speak("LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n.", false);
            }
        } catch (e) { speak("Sepet hatasÄ±."); }
    }

    function displayProducts(products, shouldSpeak = true) {
        container.innerHTML = "";
        let speechText = "Ä°ÅŸte Ã¼rÃ¼nler: ";

        products.forEach((prod, index) => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <div class="card-number">${index + 1}</div>
                <img src="${prod.image}" class="product-img" onerror="this.src='https://placehold.co/400?text=Resim+Yok'">
                <div class="product-name">${prod.name}</div>
                <div class="product-price">${prod.price} TL</div>
                <button class="add-btn" onclick="addToCart({id:${prod.id}, name:'${prod.name.replace(/'/g, "\\'")}'}); event.stopPropagation();">SEPETE EKLE</button>
            `;
            card.onclick = () => addToCart(prod);
            container.appendChild(card);
            speechText += `${index + 1}, ${prod.name}, ${Math.floor(prod.price)} lira. `;
        });

        if(shouldSpeak) {
            speechText += "Hangisini istersiniz?";
            speak(speechText, true);
        }
    }

    micButton.addEventListener('click', () => toggleMic());
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && document.activeElement !== textInput) {
            e.preventDefault();
            if (overlay.style.display !== 'none') startApp();
            else toggleMic();
        }
    });
</script>
{% endblock %}